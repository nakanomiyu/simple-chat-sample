<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Mini Ball Game ğŸ®</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: linear-gradient(180deg, #f8f9fa 0%, #c9e8ff 100%);
      font-family: 'ãƒ’ãƒ©ã‚®ãƒä¸¸ã‚´ ProN', sans-serif;
    }
    #info {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.8);
      padding: 8px 12px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
  </style>
</head>
<body>
<div id="info">ğŸ® ã‚¹ãƒãƒ›ã‚’å‚¾ã‘ã¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«å½“ã¦ã‚ˆã†ï¼</div>

<script>
let ballX, ballY;
let targetX, targetY;
let startTime, endTime;
let gameStarted = false;
let cleared = false;   // â† ã‚¯ãƒªã‚¢æ¸ˆã¿ãƒ•ãƒ©ã‚°è¿½åŠ ï¼
let score = 0;

function setup() {
  createCanvas(windowWidth, windowHeight);
  textAlign(CENTER, CENTER);
  textSize(24);
  resetGame();
}

function resetGame() {
  ballX = width / 2;
  ballY = height / 2;
  targetX = random(80, width - 80);
  targetY = random(120, height - 120);
  gameStarted = false;
  cleared = false; // â† å†ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã«è§£é™¤
}

function draw() {
  background(240);

  // å¤–æ 
  stroke(180);
  strokeWeight(3);
  noFill();
  rect(10, 10, width - 20, height - 20, 15);

  // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
  noStroke();
  fill(255, 120, 120);
  ellipse(targetX, targetY, 50, 50);
  fill(255, 255, 255, 100);
  ellipse(targetX, targetY, 30, 30);

  // ãƒœãƒ¼ãƒ«
  fill(100, 150, 255);
  ellipse(ballX, ballY, 50, 50);

  // ã‚¹ã‚³ã‚¢ãƒ»ã‚¿ã‚¤ãƒ è¡¨ç¤º
  fill(50);
  textAlign(LEFT, TOP);
  text("ğŸ† SCORE: " + score, 25, 25);

  textAlign(RIGHT, TOP);
  if (gameStarted) {
    const now = millis();
    text("â± " + ((now - startTime) / 1000).toFixed(2) + " ç§’", width - 25, 25);
  } else {
    text("Ready?", width - 25, 25);
  }

  // ä¸­å¤®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  if (!gameStarted) {
    fill(70);
    textAlign(CENTER, CENTER);
    text("ã‚¹ãƒãƒ›ã‚’å‚¾ã‘ã¦ã‚¹ã‚¿ãƒ¼ãƒˆï¼", width / 2, height / 2);
  }
}

// --- ã‚½ã‚±ãƒƒãƒˆé€šä¿¡è¨­å®š ---
const socket = io.connect(window.location.origin);
socket.emit('join', 'game'); // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ å‚åŠ 

socket.on('sensor', data => {
  // ã‚¹ã‚¿ãƒ¼ãƒˆã‚¿ã‚¤ãƒ ã‚’ç¢ºå®Ÿã«æœ€åˆã ã‘è¨­å®š
  if (!gameStarted) {
    gameStarted = true;
    startTime = millis();
    cleared = false;
  }

  if (cleared) return; // â† ã‚¯ãƒªã‚¢å¾Œã¯å‡¦ç†ã‚¹ãƒˆãƒƒãƒ—ï¼

  // å‚¾ãã«åˆã‚ã›ã¦ãƒœãƒ¼ãƒ«ã‚’å‹•ã‹ã™
  ballX += data.g / 2; // gamma
  ballY += data.b / 2; // beta

  // ç”»é¢ã®ç«¯ã§æ­¢ã¾ã‚‹
  ballX = constrain(ballX, 35, width - 35);
  ballY = constrain(ballY, 35, height - 35);

  // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«å½“ãŸã£ãŸã‚‰ï¼ˆ1å›ã ã‘å‡¦ç†ï¼‰
  const d = dist(ballX, ballY, targetX, targetY);
  if (d < 40 && !cleared) {
    cleared = true; // â† äºŒé‡å‡¦ç†é˜²æ­¢ï¼
    endTime = millis();
    score++;

    const clearTime = ((endTime - startTime) / 1000).toFixed(2);
    alert(`ğŸ‰ã‚¯ãƒªã‚¢ï¼ã‚¿ã‚¤ãƒ : ${clearTime} ç§’âœ¨`);
    resetGame();
  }
});

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}
</script>
</body>
</html>
