<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Ball Game</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
<script>
let ballX, ballY;
let targetX, targetY;
let startTime, endTime;
let gameStarted = false;

function setup() {
  createCanvas(windowWidth, windowHeight);
  textAlign(CENTER, CENTER);
  textSize(24);
  resetGame();
}

function resetGame() {
  // p5.js の random() を setup() の中で呼ぶ！
  ballX = width / 2;
  ballY = height / 2;
  targetX = random(50, width - 50);
  targetY = random(50, height - 50);
  gameStarted = false;
}

function draw() {
  background(240);

  // ターゲット
  fill(255, 100, 100);
  ellipse(targetX, targetY, 40, 40);

  // ボール
  fill(100, 150, 255);
  ellipse(ballX, ballY, 50, 50);

  if (gameStarted) {
    const now = millis();
    fill(0);
    text("Time: " + ((now - startTime) / 1000).toFixed(2) + " s", width / 2, 40);
  } else {
    fill(0);
    text("スマホを傾けてスタート！", width / 2, height / 2);
  }
}

// --- 加速度データを受け取る ---
const socket = io.connect(window.location.origin);
socket.on("sensor", data => {
  if (!gameStarted) {
    gameStarted = true;
    startTime = millis(); // ← setupの後で宣言されるからOK！
  }

  // スマホの傾きデータを使ってボールを動かす
  ballX += data.g / 2;  // gamma（左右）
  ballY += data.b / 2;  // beta（前後）

  // 壁の外に出ないように
  ballX = constrain(ballX, 25, width - 25);
  ballY = constrain(ballY, 25, height - 25);

  // ターゲットに当たったら！
  const d = dist(ballX, ballY, targetX, targetY);
  if (d < 40 && gameStarted) {
    gameStarted = false;
    endTime = millis();
    alert("クリア！タイム: " + ((endTime - startTime) / 1000).toFixed(2) + " 秒✨");
    resetGame();
  }
});
</script>
</body>
</html>