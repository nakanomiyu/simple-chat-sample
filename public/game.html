<!doctype html>
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tilt Ball Challenge ğŸ®</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #f0f8ff;
      font-family: 'ãƒ’ãƒ©ã‚®ãƒä¸¸ã‚´ ProN', sans-serif;
    }
    #info {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.8);
      padding: 8px 12px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
  </style>
</head>
<body>
<div id="info">ğŸ® ã‚¹ãƒãƒ›ã‚’å‚¾ã‘ã¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«å½“ã¦ã‚ˆã†ï¼</div>

<script>
let ballX, ballY;
let targetX, targetY;
let startTime, endTime;
let gameStarted = false;
let cleared = false;
let score = 0;
let fadeAlpha = 0;

// ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–¢é€£
let countdown = 3;
let countdownActive = false;

// --- ã‚¹ãƒ†ãƒ¼ã‚¸èƒŒæ™¯ã‚«ãƒ©ãƒ¼ ---
function getStageColor() {
  const colors = [
    [200, 230, 255],
    [220, 255, 220],
    [255, 230, 240],
    [250, 250, 200]
  ];
  return colors[score % colors.length];
}

function setup() {
  createCanvas(windowWidth, windowHeight);
  textAlign(CENTER, CENTER);
  textSize(24);
  resetGame();
}

function resetGame() {
  ballX = width / 2;
  ballY = height / 2;
  targetX = random(80, width - 80);
  targetY = random(120, height - 120);
  gameStarted = false;
  cleared = false;
  countdownActive = false;
  fadeAlpha = 0;
}

function startCountdown() {
  countdown = 3;
  countdownActive = true;
  let timer = setInterval(() => {
    countdown--;
    if (countdown <= 0) {
      clearInterval(timer);
      countdownActive = false;
      gameStarted = true;
      startTime = millis();
    }
  }, 1000);
}

function draw() {
  const c = getStageColor();
  background(c[0], c[1], c[2]);

  // å¤–æ 
  stroke(180);
  strokeWeight(3);
  noFill();
  rect(10, 10, width - 20, height - 20, 15);

  // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
  noStroke();
  fill(255, 120, 120);
  ellipse(targetX, targetY, 50, 50);
  fill(255, 255, 255, 100);
  ellipse(targetX, targetY, 30, 30);

  // ãƒœãƒ¼ãƒ«
  fill(100, 150, 255);
  ellipse(ballX, ballY, 50, 50);

  // ã‚¹ã‚³ã‚¢ãƒ»ã‚¿ã‚¤ãƒ è¡¨ç¤º
  fill(50);
  textAlign(LEFT, TOP);
  text("ğŸ† SCORE: " + score, 25, 25);

  textAlign(RIGHT, TOP);
  if (gameStarted) {
    const now = millis();
    text("â± " + ((now - startTime) / 1000).toFixed(2) + " ç§’", width - 25, 25);
  } else {
    text("Ready?", width - 25, 25);
  }

  // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º
  if (countdownActive) {
    fill(255, 0, 0);
    textSize(60);
    textAlign(CENTER, CENTER);
    text(countdown > 0 ? countdown : "GO!", width / 2, height / 2);
  }

  // ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã®æ¡ˆå†…
  if (!gameStarted && !countdownActive) {
    fill(70);
    textSize(24);
    textAlign(CENTER, CENTER);
    text("ã‚¹ãƒãƒ›ã‚’å‚¾ã‘ã¦ã‚¹ã‚¿ãƒ¼ãƒˆï¼", width / 2, height / 2);
  }

  // ãƒ•ã‚§ãƒ¼ãƒ‰æ¼”å‡º
  if (fadeAlpha > 0) {
    fill(255, fadeAlpha);
    rect(0, 0, width, height);
    fadeAlpha -= 10;
  }
}

// --- ã‚½ã‚±ãƒƒãƒˆé€šä¿¡è¨­å®š ---
const socket = io.connect(window.location.origin);
socket.emit('join', 'game');

socket.on('sensor', data => {
  // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆ1å›ã ã‘ï¼‰
  if (!gameStarted && !countdownActive && !cleared) {
    startCountdown();
    return;
  }

  if (cleared || countdownActive) return;

  // å‚¾ãã«åˆã‚ã›ã¦ãƒœãƒ¼ãƒ«ã‚’å‹•ã‹ã™
  ballX += data.g / 2; // gamma
  ballY += data.b / 2; // beta

  // ç”»é¢ã®ç«¯ã§æ­¢ã¾ã‚‹
  ballX = constrain(ballX, 35, width - 35);
  ballY = constrain(ballY, 35, height - 35);

  // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«å½“ãŸã£ãŸã‚‰ï¼ˆ1å›ã ã‘å‡¦ç†ï¼‰
  const d = dist(ballX, ballY, targetX, targetY);
  if (d < 40 && !cleared) {
    cleared = true;
    endTime = millis();
    score++;
    fadeAlpha = 255;

    const clearTime = ((endTime - startTime) / 1000).toFixed(2);

    setTimeout(() => {
      alert(`ğŸ‰CLEAR!! ã‚¿ã‚¤ãƒ : ${clearTime} ç§’âœ¨`);
      resetGame();
    }, 800);
  }
});

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}
</script>
</body>
</html>
